<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Akustik & Air</title>
    <style>
        body {
            background-color: #050505;
            color: #e0e0e0;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            user-select: none;
        }

        h1 { margin: 0 0 10px 0; font-weight: 300; color: #00d2ff; }
        
        /* TOMBOL KEMBALI (BARU) */
        .btn-back {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 30, 30, 0.8);
            color: #fff;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            z-index: 100;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        .btn-back:hover {
            background: #333;
            border-color: #00d2ff;
            color: #00d2ff;
        }

        /* FRAME KOLAM */
        .pool-container {
            position: relative;
            padding: 10px;
            background: #222;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            border: 1px solid #444;
        }

        canvas {
            display: block;
            border: 2px solid #000;
            background: #000;
            cursor: crosshair;
            width: 800px; 
            height: 450px;
            image-rendering: pixelated; 
        }

        /* TOOLBAR */
        .toolbar {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            background: #1a1a1a;
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid #333;
        }

        .tool-btn {
            background: transparent;
            border: 2px solid transparent;
            color: #888;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tool-btn:hover { color: #fff; background: #333; }
        
        .tool-btn.active {
            background: #333;
            color: #fff;
            border-color: currentColor;
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }

        /* Warna Tombol Sesuai Fungsi */
        .btn-water.active { color: #00d2ff; border-color: #00d2ff; }
        .btn-wall.active { color: #ffffff; border-color: #ffffff; }
        .btn-foam.active { color: #00ff9d; border-color: #00ff9d; }
        .btn-clear { color: #ff3366; } .btn-clear:hover { background: #ff3366; color: white; }

        .status {
            margin-top: 10px;
            font-size: 0.8em;
            color: #555;
        }

        @media (max-width: 820px) {
            canvas { width: 95vw; height: 50vh; }
            .pool-container { width: 95vw; padding: 5px; }
            .toolbar { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>

    <!-- Tombol Back dengan Logika History -->
    <button class="btn-back" onclick="goBack()">
        ‚¨Ö Kembali
    </button>

    <h1>Acoustic Lab</h1>

    <div class="pool-container">
        <canvas id="simCanvas" width="200" height="112"></canvas>
    </div>

    <div class="toolbar">
        <button class="tool-btn active btn-water" onclick="setTool(0)">
            üíß Air (Source)
        </button>
        <button class="tool-btn btn-wall" onclick="setTool(1)">
            üß± Tembok (Reflect)
        </button>
        <button class="tool-btn btn-foam" onclick="setTool(2)">
            üßΩ Busa (Absorb)
        </button>
        <button class="tool-btn btn-clear" onclick="resetPool()">
            ‚ùå Reset
        </button>
    </div>

    <div class="status">Klik & Drag di kolam. Nyalakan volume laptop.</div>

    <script>
        // FUNGSI NAVIGASI
        function goBack() {
            // Jika ada riwayat (dibuka di tab yang sama), kembali.
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // Jika tidak ada riwayat (misal dibuka langsung), tutup window (opsional)
                // atau arahkan manual ke file presentasi
                window.location.href = 'sound_system_workflow.html';
            }
        }

        // --- KONFIGURASI ENGINE ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        let currentBuffer = new Float32Array(width * height);
        let previousBuffer = new Float32Array(width * height);
        let obstacleMap = new Uint8Array(width * height);
        const imgData = ctx.getImageData(0, 0, width, height);
        const data = imgData.data;

        let damping = 0.96; 
        let activeTool = 0; 
        let isDrawing = false;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playDropSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }

        function handleInput(x, y) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = width / rect.width;
            const scaleY = height / rect.height;
            const cx = Math.floor((x - rect.left) * scaleX);
            const cy = Math.floor((y - rect.top) * scaleY);

            if (cx < 1 || cx >= width - 1 || cy < 1 || cy >= height - 1) return;

            if (activeTool === 0) {
                currentBuffer[cy * width + cx] = 500; 
                playDropSound(); 
            } else {
                const radius = 2; 
                for(let i = -radius; i <= radius; i++) {
                    for(let j = -radius; j <= radius; j++) {
                        const drawX = cx + i;
                        const drawY = cy + j;
                        if(drawX > 0 && drawX < width && drawY > 0 && drawY < height) {
                            obstacleMap[drawY * width + drawX] = activeTool;
                            currentBuffer[drawY * width + drawX] = 0;
                            previousBuffer[drawY * width + drawX] = 0;
                        }
                    }
                }
            }
        }

        canvas.addEventListener('mousedown', e => { isDrawing = true; handleInput(e.clientX, e.clientY); });
        window.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mousemove', e => { if(isDrawing) handleInput(e.clientX, e.clientY); });
        canvas.addEventListener('touchstart', e => { 
            e.preventDefault(); 
            isDrawing = true; 
            handleInput(e.touches[0].clientX, e.touches[0].clientY); 
        });
        canvas.addEventListener('touchmove', e => { 
            e.preventDefault(); 
            if(isDrawing) handleInput(e.touches[0].clientX, e.touches[0].clientY); 
        });

        function update() {
            for (let i = width; i < width * height - width; i++) {
                const obs = obstacleMap[i];
                if (obs === 1) { 
                    currentBuffer[i] = 0; 
                    continue; 
                }
                let val = (
                    previousBuffer[i - 1] + 
                    previousBuffer[i + 1] + 
                    previousBuffer[i - width] + 
                    previousBuffer[i + width]
                ) / 2 - currentBuffer[i];

                if (obs === 2) {
                    val = val * 0.5; 
                } else {
                    val = val * damping; 
                }
                currentBuffer[i] = val;
            }

            for (let i = 0; i < width * height; i++) {
                const obs = obstacleMap[i];
                const index = i * 4;

                if (obs === 1) {
                    data[index] = 200; data[index+1] = 200; data[index+2] = 200; data[index+3] = 255;
                } else if (obs === 2) {
                    data[index] = 20; data[index+1] = 100; data[index+2] = 50; data[index+3] = 255;
                } else {
                    let val = currentBuffer[i];
                    data[index] = 0;
                    data[index+1] = Math.max(0, val + 50); 
                    data[index+2] = Math.max(0, val + 150); 
                    data[index+3] = 255;
                }
            }

            ctx.putImageData(imgData, 0, 0);
            let temp = previousBuffer;
            previousBuffer = currentBuffer;
            currentBuffer = temp;
            requestAnimationFrame(update);
        }

        function setTool(id) {
            activeTool = id;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            if(id===0) document.querySelector('.btn-water').classList.add('active');
            if(id===1) document.querySelector('.btn-wall').classList.add('active');
            if(id===2) document.querySelector('.btn-foam').classList.add('active');
        }

        function resetPool() {
            currentBuffer.fill(0);
            previousBuffer.fill(0);
            obstacleMap.fill(0);
        }

        update();
    </script>
</body>
</html>